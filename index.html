<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
    <meta name="description" content="Maestro â€” Real-time AR tennis coaching in your browser. No install required." />
    <meta name="theme-color" content="#0a0a0f" />
    <!-- iOS fullscreen hints -->
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <title>Maestro â€” AR Tennis Coach</title>

    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet" />

    <!-- App styles -->
    <link rel="stylesheet" href="css/styles.css" />

    <!--
    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘  Three.js â€” ESM via import map (no bundler needed)      â•‘
    â•‘  Using jsDelivr CDN for reliability and HTTPS.          â•‘
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    Import maps allow us to write `import * as THREE from 'three'`
    in our ES module scripts instead of full CDN URLs.
  -->
    <script type="importmap">
    {
      "imports": {
        "three": "https://cdn.jsdelivr.net/npm/three@0.169.0/build/three.module.js",
        "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.169.0/examples/jsm/",
        "@mediapipe/tasks-vision": "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.14/vision_bundle.mjs"
      }
    }
  </script>

    <!--
    MediaPipe Tasks Vision is loaded via the import map above as an ES module.
    No separate <script> tag needed â€” ar-tracking.js imports it directly.
  -->
</head>

<body>
    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       AR VIEWPORT â€” video feed + Three.js canvas
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div id="ar-container">

        <!-- Live camera feed â€” CSS-mirrored via scaleX(-1) in styles.css -->
        <video id="webcam" autoplay playsinline muted></video>

        <!-- Three.js transparent overlay canvas -->
        <canvas id="three-canvas"></canvas>

        <!-- â”€â”€ HUD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
        <div id="hud" aria-live="polite" aria-label="Coaching information">

            <!-- Top bar: phase badge + camera switch -->
            <div id="hud-top">
                <span id="phase-badge" role="status">IDLE</span>
                <button id="camera-btn" aria-label="Switch camera" title="Switch front / rear camera">âŸ³</button>
            </div>

            <!-- Bottom coaching panel -->
            <div id="coaching-panel" role="region" aria-label="Coaching panel">

                <!-- Coach message text -->
                <div id="coach-message">ðŸŽ¾ Tap Start to begin</div>

                <!-- Score bar -->
                <div class="score-row">
                    <span class="score-label">FORM</span>
                    <div class="score-track">
                        <div id="score-bar" style="width:0%"></div>
                    </div>
                    <span id="score-value">0</span>
                </div>

                <!-- Swing counter -->
                <div id="swing-counter">No swings yet â€” start your first swing!</div>

            </div><!-- /coaching-panel -->
        </div><!-- /hud -->

        <!-- â”€â”€ Loading indicator â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
        <div id="loading-overlay" aria-live="polite">
            <div class="loader-ring"></div>
            <span class="loader-text">Loadingâ€¦</span>
        </div>

        <!-- â”€â”€ Splash / permission screen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
        <div id="splash-screen" role="dialog" aria-modal="true" aria-labelledby="splash-title">
            <div class="splash-logo" id="splash-title">Maestro</div>
            <p class="splash-sub">
                Your real-time AR tennis coach.<br />
                Points your phone's camera at yourself and Maestro will analyse your swing form live.
            </p>
            <button id="start-btn" autofocus>Start coaching â†’</button>
            <p class="splash-sub" style="font-size:0.75rem; margin-top:8px;">
                Camera access required Â· No data leaves your device
            </p>
        </div><!-- /splash-screen -->

    </div><!-- /ar-container -->

    <!--
    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘  Main application script â€” ES module                   â•‘
    â•‘                                                          â•‘
    â•‘  Architecture:                                           â•‘
    â•‘    ARTracking  â”€â”€â†’  coaching-engine.js                  â•‘
    â•‘                         â”‚                               â•‘
    â•‘         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                               â•‘
    â•‘         â†“               â†“                               â•‘
    â•‘    three-renderer.js   ui.js                            â•‘
    â•‘                                                          â•‘
    â•‘  Each module is completely independent â€” swap any one   â•‘
    â•‘  without touching the others.                           â•‘
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  -->
    <script type="module">
        // â”€â”€ Imports â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        import { ARTracking } from './js/ar-tracking.js';
        import { CoachingEngine } from './js/coaching-engine.js';
        import { ThreeRenderer } from './js/three-renderer.js';
        import { UI } from './js/ui.js';

        // â”€â”€ DOM references â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const videoEl = document.getElementById('webcam');
        const canvasEl = document.getElementById('three-canvas');
        const startBtn = document.getElementById('start-btn');
        const splashEl = document.getElementById('splash-screen');
        const cameraBtn = document.getElementById('camera-btn');
        const loadingEl = document.getElementById('loading-overlay');

        // â”€â”€ Module instances â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const ui = new UI();
        let coachingEngine = null;
        let threeRenderer = null;
        let arTracking = null;

        // â”€â”€ Initialise Three.js renderer immediately (no async needed) â”€â”€â”€
        // We do this before the user taps Start so the canvas is ready.
        function initRenderer() {
            // Size the canvas to match its CSS layout size
            canvasEl.width = canvasEl.clientWidth * window.devicePixelRatio;
            canvasEl.height = canvasEl.clientHeight * window.devicePixelRatio;
            threeRenderer = new ThreeRenderer(canvasEl);
        }

        // â”€â”€ Start button handler â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        startBtn.addEventListener('click', async () => {
            // Dismiss splash
            splashEl.classList.add('hidden');

            // Show loading state
            ui.showLoading('Requesting cameraâ€¦');

            try {
                // Initialise Three.js renderer
                initRenderer();

                // Show second loading phase
                ui.showLoading('Loading pose model â€“ first run may take a momentâ€¦');

                // â”€â”€ Pose result callback â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                // This is called by ARTracking on every detected frame.
                // It is the ONLY connection point between tracking and coaching.
                coachingEngine = new CoachingEngine();

                function onPoseResult(landmarks, worldLandmarks) {
                    // 1. Analyse pose â†’ get coaching state
                    const coachingState = coachingEngine.analyse(landmarks);

                    // 2. Get wrist history for arc rendering
                    const wristHistory = coachingEngine.getWristHistory();

                    // 3. Render Three.js overlays
                    threeRenderer.render(landmarks, coachingState, wristHistory);

                    // 4. Update HUD
                    ui.update(coachingState);
                }

                // â”€â”€ Start AR tracking â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                arTracking = new ARTracking(videoEl, onPoseResult);
                await arTracking.start();

                // Hide loading, we're live!
                ui.hideLoading();

            } catch (err) {
                console.error('[Maestro] Startup failed:', err);
                ui.showLoading(`Error: ${err.message}. Please check camera permissions and reload.`);
            }
        });

        // â”€â”€ Camera switch handler â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        cameraBtn.addEventListener('click', async () => {
            if (!arTracking) return;
            cameraBtn.style.opacity = '0.5';
            cameraBtn.disabled = true;
            try {
                await arTracking.switchCamera();
            } finally {
                cameraBtn.style.opacity = '1';
                cameraBtn.disabled = false;
            }
        });

        // â”€â”€ Handle page visibility changes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // Stop pose detection when the app is backgrounded to save battery.
        document.addEventListener('visibilitychange', () => {
            if (!arTracking) return;
            if (document.hidden) {
                arTracking.stop();
            } else {
                // Restart detection on foreground
                arTracking.start().catch(console.error);
            }
        });

        // â”€â”€ Hide loading overlay initially until Start is clicked â”€â”€â”€â”€â”€â”€â”€â”€
        // (We show a splash screen instead on first load.)
        loadingEl.classList.add('hidden');

    </script>
</body>

</html>